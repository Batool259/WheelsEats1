{% extends "base.html" %}

{% block TITLE %}Karte{% endblock %}

{% block CONTENT %}
<h2>Restaurant-Karte</h2>
<p class="text-muted">Alle Restaurants mit Standort werden als Pins angezeigt.</p>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<div id="map" style="height: 520px; border-radius: 16px;"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Restaurants aus Flask/Jinja (schon JSON-fähig dank dict-Liste)
  const restaurants = {{ restaurants | tojson }};

  // Karte initialisieren (Fallback: Berlin)
  const map = L.map("map").setView([52.5200, 13.4050], 12);

  // OpenStreetMap Tiles
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markers = [];

  restaurants.forEach(r => {
    if (r.lat == null || r.lng == null) return;

    const marker = L.marker([r.lat, r.lng]).addTo(map);

    const popupHtml = `
      <strong>${r.name}</strong><br>
      <small>${r.adresse || ""}</small><br>
      <a href="/restaurants/${r.id}">Details öffnen</a>
    `;

    marker.bindPopup(popupHtml);
    markers.push(marker);
  });

  // Karte automatisch auf alle Marker zoomen
  if (markers.length > 0) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }
</script>
{% endblock %}
